import{C as j}from"./vendor-f40b56c0.js";import{d as g}from"./displayError-0ab9c496.js";import{_ as w}from"./preload-helper-ec9aa979.js";const I="",b=I+"/api",S=`${b}/user`,K=`${S}/login`,Y=`${S}/register`,L=`${b}/file`,z=`${L}/download`,R=`${b}/folder`,G=`${R}/list`,M=s=>t=>s+"?"+new URLSearchParams(t);async function f(s){let t="",e=!0;s.catch(n=>{t=n,e=!1});const r=await s;return e?r.ok?{ok:e,message:void 0,res:r}:{ok:!1,message:await r.text(),res:r}:{ok:e,message:t,res:r}}function k(s,t){const e=s.getReader();let r;return new ReadableStream({start(){r=new Uint8Array(0)},async pull(n){const{done:o,value:a}=await e.read();if(o){n.enqueue(r),n.close(),e.releaseLock();return}try{r=Uint8Array.from([...r,...a])}catch(i){console.error({error:i,value:a})}for(;r.length>=t;){const i=r.subarray(0,t);n.enqueue(i),r=r.subarray(t,r.length)}},cancel(){e.releaseLock()}})}function v(s){return typeof s=="boolean"&&!s}function N(s,t,e,r){t+=e.crypto_secretstream_xchacha20poly1305_ABYTES;const o=k(s,t).getReader();return new ReadableStream({async start(a){for(;;){const i=await o.read();if(i.done)break;const y=i.value.length===t?i.value:i.value.subarray(0,-e.crypto_secretstream_xchacha20poly1305_ABYTES),h=e.crypto_secretstream_xchacha20poly1305_pull(r,y);if(v(h)){const _="Fatal error while decoding message";return console.error(_),Promise.reject(_)}const{message:m,tag:T}=h;if(T===e.crypto_secretstream_xchacha20poly1305_TAG_FINAL){const _="Unexpected end of stream";return console.error(_),Promise.reject(_)}if(a.enqueue(m),i.value.length!==t){const _=i.value.subarray(-e.crypto_secretstream_xchacha20poly1305_ABYTES),p=e.crypto_secretstream_xchacha20poly1305_pull(r,_);if(v(p)){const u="Fatal error while decoding closing message";return console.error(u),Promise.reject(u)}if(p.tag!==e.crypto_secretstream_xchacha20poly1305_TAG_FINAL){const u=`Expected end of stream, found ${e.to_base64(p.message)}`;return console.error(u),Promise.reject(u)}}}a.close(),o.releaseLock()}})}function F(s,t,e,r){const o=k(s,t).getReader();return new ReadableStream({async start(a){let i;for(;;){const{done:y,value:h}=await o.read();if(y){console.log(e.to_base64(i));break}const m=e.crypto_secretstream_xchacha20poly1305_push(r,h,null,e.crypto_secretstream_xchacha20poly1305_TAG_PUSH);i=m,a.enqueue(m)}a.enqueue(e.crypto_secretstream_xchacha20poly1305_push(r,new Uint8Array(0),null,e.crypto_secretstream_xchacha20poly1305_TAG_FINAL)),a.close(),o.releaseLock()}})}async function H(){await w(()=>import("./libsodium-wrappers-3300ce5f.js").then(function(s){return s.l}),[])}class O{}let c=null;function J(){return c}const P=8*1024;class l{constructor(){this._libSodium=null,this._keyStore=new O,this._initPromise=(async()=>{console.log("Initializing LibSodium");const t=(await w(()=>import("./libsodium-wrappers-3300ce5f.js").then(function(e){return e.l}),[])).default;await t.ready,this._libSodium=t,console.log("LibSodium is initialized")})()}get initialized(){return this._libSodium?Promise.resolve(this):this._initPromise.then(()=>this)}static async fromMasterKey(t){return c=await new l().initialized,c._keyStore.masterKey=c._libSodium.from_base64(t),c}static async fromPasswordAndSalt(t,e){return c=await new l().initialized,c._deriveMasterKey(t,c._libSodium.from_base64(e)),c}static async createUser(t){const e=await new l().initialized,r=e._libSodium.randombytes_buf(e._libSodium.crypto_pwhash_SALTBYTES);e._deriveMasterKey(t,r);const n=e._libSodium.crypto_box_keypair();e._keyStore.shareKeyPair={priv:n.privateKey,pub:n.publicKey},e._keyStore.sharePrivateKeyNonce=e._libSodium.randombytes_buf(e._libSodium.crypto_secretbox_NONCEBYTES);const o=e._libSodium.crypto_secretbox_easy(e._keyStore.shareKeyPair.priv,e._keyStore.sharePrivateKeyNonce,e._keyStore.masterKey);return c=e,{manager:e,keys:{masterKeySalt:e._libSodium.to_base64(e._keyStore.masterKeySalt),authKey:e._libSodium.to_base64(e._deriveAuthKey()),sharePublicKey:e._libSodium.to_base64(e._keyStore.shareKeyPair.pub),sharePrivateKeyEnc:e._libSodium.to_base64(o),sharePrivateKeyNonce:e._libSodium.to_base64(e._keyStore.sharePrivateKeyNonce)}}}_deriveMasterKey(t,e){if(!this._libSodium)throw new Error("KeyStore is not initialized");console.log("Started MasterKey derivation");const r=this._libSodium.crypto_pwhash(32,t,e,this._libSodium.crypto_pwhash_OPSLIMIT_MODERATE,this._libSodium.crypto_pwhash_MEMLIMIT_MODERATE,this._libSodium.crypto_pwhash_ALG_DEFAULT);this._keyStore.masterKey=r,this._keyStore.masterKeySalt=e,console.log("MasterKey derived successfully")}_deriveAuthKey(){if(!this._libSodium)throw new Error("KeyStore is not initialized");return this._libSodium.crypto_hash(this._keyStore.masterKey)}setShareKey(t,e,r){this._keyStore.sharePrivateKeyNonce=this._libSodium.from_base64(r),this._keyStore.shareKeyPair={pub:this._libSodium.from_base64(t),priv:this._libSodium.crypto_secretbox_open_easy(this._libSodium.from_base64(e),this._keyStore.sharePrivateKeyNonce,this._keyStore.masterKey)}}async encryptFile(t){const e=this._libSodium,r=e.crypto_secretstream_xchacha20poly1305_keygen(),{state:n,header:o}=e.crypto_secretstream_xchacha20poly1305_init_push(r),a=F(t,P,e,n),i=e.randombytes_buf(e.crypto_secretbox_NONCEBYTES),y=e.crypto_secretbox_easy(r,i,this._keyStore.masterKey);return{data:await new Response(a).blob(),header:e.to_base64(o),key:{keyEnc:e.to_base64(y),nonce:e.to_base64(i)}}}async decryptFile(t,e,r,n){const o=this._libSodium,a=o.crypto_secretbox_open_easy(o.from_base64(r),o.from_base64(n),this._keyStore.masterKey),i=o.crypto_secretstream_xchacha20poly1305_init_pull(o.from_base64(e),a),y=N(t,P,o,i);return new Response(y).blob()}getAuthKey(){return this._libSodium.to_base64(this._deriveAuthKey())}getMasterKey(){return this._libSodium.to_base64(this._keyStore.masterKey)}}function E(){return sessionStorage.getItem("jwt")}function A(){return sessionStorage.getItem("masterKey")}const d=j(!1);function U(){return new Headers({Authorization:"Bearer "+E()})}d.subscribe(s=>s);function x(){sessionStorage.removeItem("jwt"),sessionStorage.removeItem("masterKey"),d.set(!1)}async function V(){if(!E()||!A())return!1;const s=fetch(K,{headers:U()}),t=await f(s).catch(()=>{x()});if(!t)return!1;const{ok:e,message:r}=t;return e?l.fromMasterKey(A()):(console.warn(r),x()),d.set(e),e}const $=M(S);async function D(s,t){const e=fetch(K,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:s,authKey:t.getAuthKey()})}),{res:r,ok:n,message:o}=await f(e);if(!n)return g(o),Promise.reject(o);const a=await r.json();t.setShareKey(a.user.shareKeyPublic,a.user.shareKeyPrivate,a.user.shareKeyNonce),sessionStorage.setItem("jwt",a.token),sessionStorage.setItem("masterKey",t.getMasterKey()),d.set(!0)}async function W(s,t){const e=fetch($({username:s})),{ok:r,message:n,res:o}=await f(e);if(!r)return g(n),Promise.reject(n);const a=await o.json(),i=await l.fromPasswordAndSalt(t,a.masterKeySalt);await D(s,i)}export{l as C,d as a,D as b,f as c,x as d,U as e,L as f,M as g,R as h,V as i,G as j,J as k,W as l,z as m,H as p,Y as r};
